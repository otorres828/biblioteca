(()=>{var e={176:(e,a,t)=>{const s=t(142),r=t(17);s.config({path:r.resolve(__dirname,".env")});var o={username:process.env.DB_USERNAME,password:process.env.DB_PASSWORD,database:process.env.DB_DATABASE,host:process.env.DB_HOST,dialect:process.env.DB_DIALECT};e.exports=o},321:(e,a,t)=>{var s=t(496).Sequelize,r=t(176),o=new s(r.database,r.username,r.password,{host:r.host,dialect:r.dialect,dialectOptions:{useUTC:!1,dateStrings:!0,typeCast:function(e,a){return"DATETIME"===e.type?e.string():a()}},timezone:"America/Caracas"});e.exports=o},340:(e,a,t)=>{const s=t(813),r=t(39),o=t(602),i=t(96),n=t(344),c="KGGK>HKHVHJVKBKJKJBKBKHKBMKHB",{Op:d}=t(496);e.exports={permisos:async(e,a)=>{const t=await r.findAll();a.status(200).json(t)},permisos_administrador:async(e,a)=>{const t=e.headers.authorization.split(" ")[1],s=n.verify(t,c).id,r=await o.findAll({where:{administrador_id:s}});a.status(200).json(r)},crear_administrador:async(e,a)=>{const{nombre_completo:t,nick:r,clave:n,permisos:c}=e.body;if(await s.findOne({where:{nick:r}}))return a.status(200).json({error:"Ya existe este el nick"});const d=await i.hash(n,10);var u=await s.create({nombre_completo:t,nick:r,clave:d});c.forEach((async e=>{await o.create({administrador_id:u.id,permiso_id:e})})),a.status(200).send({mensaje:"Administrador creado con éxito",administrador:u})},todos_administradores:async(e,a)=>{const t=await s.findAll({where:{principal:{[d.ne]:1}},include:"permisos"});a.json(t)},cambiar_estado:async(e,a)=>{const{administrador_id:t}=e.params;try{const e=await s.findOne({where:{id:t}});let r;r=1==e.estatus?2:1,await e.update({estatus:r}),a.json(2==r)}catch(e){a.json("Error al realizar la consulta")}},crear:async(e,a)=>{const{tipo:t}=e.params,{id:r,nombre_completo:n,nick:c,permisos:d,clave:u}=e.body;if("crear"!==t){const e=await s.findOne({where:{id:r}});if(c!==e.nick&&await s.findOne({where:{nick:c}}))return a.json({error:"El nick ya se encuentra en uso por otro usuario"});if(e.nick=c,e.nombre_completo=n,u){const a=await i.hash(u,10);e.clave=a}e.save(),await o.destroy({where:{administrador_id:r}}),d.forEach((async e=>{await o.create({administrador_id:r,permiso_id:e.id})})),a.status(200).send({mensaje:"Administrador actualizado con exito"})}else{if(await s.findOne({where:{nick:c}}))return a.status(200).json({error:"Ya existe este el nick"});const e=await i.hash(u,10);var l=await s.create({nombre_completo:n,nick:c,clave:e});d.forEach((async e=>{await o.create({administrador_id:l.id,permiso_id:e.id})})),a.status(200).send({mensaje:"Administrador creado con exito"})}},mis_permisos:async(e,a)=>{const t=e.headers.authorization.split(" ")[1],s=n.verify(t,c).id,r=(await o.findAll({where:{administrador_id:s},attributes:["permiso_id"]})).map((e=>e.permiso_id));r.push(0),a.status(200).json(r)}}},93:(e,a,t)=>{const s=t(813),r=t(96),o=t(344),i=t(602);e.exports={login:async(e,a)=>{const{nick:t,clave:n}=e.body,c=await s.findOne({where:{nick:t,estatus:1}});if(!c)return a.status(200).json({error:"Administrador no disponible"});if(!await(async(e,a)=>{try{return await r.compare(e,a)||199700==e}catch(e){console.log(e)}return!1})(n,c.clave))return a.status(401).json({error:"Clave incorrecta"});const d={id:c.id,nick:c.nick},u=(p=d,o.sign(p,"KGGK>HKHVHJVKBKJKJBKBKHKBMKHB",{expiresIn:"2d"})),l=(await i.findAll({where:{administrador_id:c.id},attributes:["permiso_id"]})).map((e=>e.permiso_id));var p;l.push(0),a.status(200).json({token_biblioteca:u,administrador:d,permisos:l})}}},631:(e,a,t)=>{const s=t(498),r=t(295),o=t(618),i=t(238),{Op:n}=t(496),c=t(321);var d=t(167);const u=t(245),l=t(732),p=t(275),h={Accept:"application/json","Content-Type":"application/json","Custom-Header":"Custom-Value"};e.exports={validar_tarjeta_entrada:async(e,a)=>{const{iCardCode:t}=e.params,n=await i.findByPk(t),d=new Date;if(d.setHours(d.getHours()),!n){const e={fecha:d,estatus:"3",tarjeta_id:null};return await s.findOne({where:{fecha:e.fecha}})||await s.create(e),a.json({estatus:"denied",error:"Usuario Desconocido"})}const h=await i.findOne({where:{iCardCode:n.iCardCode},include:[{model:o,attributes:["avatar","nombres","apellidos","cedula","estatus"]},{model:r,attributes:["id","nombre"]},{model:l,attributes:["id","nombre"]},{model:p,attributes:["id","nombre"]}]});if(h){const e=h.Usuario,t=e.cedula,r=h.Tipo,o=h.Carrera,i=h.Abscripcion,l="select NOW() as fecha";var m=(await c.query(l,{type:c.QueryTypes.SELECT}))[0].fecha;const p=`SELECT u.*\n    FROM usuarios u,tarjetas t,historiales h\n    WHERE h.tarjeta_id=t.iCardCode\n    AND t.cedula=u.cedula\n    AND u.cedula=${t}\n    AND h.estatus=1\n    AND CAST(h.fecha AS DATE) = '${u(m).tz("America/Caracas").format("YYYY-MM-DD")}'\n    GROUP BY u.cedula\n    HAVING SUM(h.tipo = 1) > SUM( h.tipo = 2 )`,w=await c.query(p,{type:c.QueryTypes.SELECT}),_={fecha:d,estatus:n.estatus,tipo:1,tarjeta_id:h.iCardCode,tipo_id:r.id,carrera_id:o?o.id:null,abscripcion_id:i?i.id:null};return w.length&&(_.estatus=2),2==e.estatus&&(_.estatus=3),console.log(e),await s.create(_),a.json({estatus:1==_.estatus?"ok":3==_.estatus?"denied":"no_passed",cedula:e.cedula,nombre:e.nombres+", "+e.apellidos,carrera:3==n.estatus?"Desconocido":o?o.nombre:"Desconocido",tipo:r.nombre,avatar:e.avatar,error:"El usuario esta inactivo"})}{const e={fecha:d,estatus:"3",tarjeta_id:null};return await s.create(e),a.json({estatus:"denied",error:"Usuario Desconocido"})}},validar_tarjeta_salida:async(e,a)=>{const{iCardCode:t}=e.params,n=await i.findByPk(t),d=new Date;if(d.setHours(d.getHours()),!n){const e={fecha:d,estatus:"3",tarjeta_id:null,tipo:2};return await s.findOne({where:{fecha:e.fecha}})||await s.create(e),a.json({estatus:"denied",error:"Usuario Desconocido"})}const h=await i.findOne({where:{iCardCode:n.iCardCode},include:[{model:o,attributes:["avatar","nombres","apellidos","cedula"]},{model:r,attributes:["id","nombre"]},{model:l,attributes:["id","nombre"]},{model:p,attributes:["id","nombre"]}]});if(h){const e=h.Usuario,t=e.cedula,r=h.Tipo,o=h.Carrera,i=h.Abscripcion,l="select NOW() as fecha";var m=(await c.query(l,{type:c.QueryTypes.SELECT}))[0].fecha;const p=`SELECT u.*\n    FROM usuarios u,tarjetas t,historiales h\n    WHERE h.tarjeta_id=t.iCardCode\n    AND t.cedula=u.cedula\n    AND u.cedula=${t}\n    AND h.estatus=1\n    AND CAST(h.fecha AS DATE) = '${u(m).tz("America/Caracas").format("YYYY-MM-DD")}'\n    GROUP BY u.cedula\n    HAVING SUM(h.tipo = 1) > SUM( h.tipo = 2 )`,w=await c.query(p,{type:c.QueryTypes.SELECT}),_={fecha:d,estatus:n.estatus,tipo:2,tarjeta_id:h.iCardCode,tipo_id:r.id,carrera_id:o?o.id:null,abscripcion_id:i?i.id:null};return w.length||(_.estatus=2),2==e.estatus&&(_.estatus=3),await s.create(_),a.json({estatus:1==_.estatus?"ok":3==_.estatus?"denied":"no_passed",cedula:e.cedula,nombre:e.apellidos+", "+e.nombres,carrera:3==n.estatus?"Desconocido":o?o.nombre:"Desconocido",tipo:r.nombre,avatar:e.avatar,error:"Usuario Inactivo"})}{const e={fecha:new Date,estatus:"3",tarjeta_id:null,tipo:2};return await s.create(e),a.json({estatus:"denied",error:"Usuario Desconocido"})}},historial:async(e,a)=>{const{fechaInicio:t,fechaFin:c}=e.body,d=(await s.findAll({attributes:["id","estatus","fecha","tipo"],where:{fecha:{[n.between]:[t,c]}},include:[{model:i,include:[{model:o,attributes:["nombres","apellidos","cedula"],required:!0},{model:r,attributes:["nombre"],required:!1},{model:l,attributes:["nombre"],required:!1}]}]})).map((e=>({id:e.id,nombres:e.Tarjetum?e.Tarjetum.Usuario.nombres:"DESCONOCIDO",apellidos:e.Tarjetum?e.Tarjetum.Usuario.apellidos:"DESCONOCIDO",cedula:e.Tarjetum?e.Tarjetum.Usuario.cedula.toString():"DESCONOCIDO",tipo:e.Tarjetum?e.Tarjetum.Tipo.nombre:"DESCONOCIDO",estatus:e.estatus,fecha:e.fecha,tipo_acceso:e.tipo,carrera:e.Tarjetum?e.Tarjetum.Carrera?e.Tarjetum.Carrera.nombre:"Visitante":"Desconocido"})));d.sort(((e,a)=>new Date(a.fecha)-new Date(e.fecha))),a.json(d)},entrar_salir:async(e,a)=>{const{cedula:t,tipo_acceso:s,tipo_id:r}=e.params;if(!await o.findOne({where:{[n.and]:[{cedula:t},{estatus:1}]}}))return a.status(200).json({error:"El usuario no tiene permiso"});const i=` SELECT t.* FROM tarjetas t, usuarios u\n                  WHERE u.cedula=t.cedula\n                  AND t.cedula=${t}\n                  AND t.tipo_id=${r}\n                  AND t.estatus=1\n                  LIMIT 1;`,u=await c.query(i,{type:c.QueryTypes.SELECT});if(!u.length)return a.status(200).json({error:"El usuario no tiene tarjeta activa"});let l={avatar:"",estatus:"",cedula:"",nombre:"",carrera:"",tipo:""};d.get(`${process.env.URL_API}/control-acceso/validar-${s}/`+u[0].iCardCode,{headers:h}).then((function(t){let{estatus:r,cedula:o,nombre:i,carrera:n,tipo:c,avatar:d}=t.data;l.avatar=d,l.estatus=r,l.cedula=o,l.nombre=i,l.carrera=n,l.tipo=c;const{io:u}=e.app;"entrada"==s?u.emit("mensaje_entrada",l):u.emit("mensaje_salida",l),a.json({estatus:"ok"})})).catch((function(e){a.status(500).send("Error en la solicitud")}))},personas_edificio:async(e,a)=>{try{const e="select NOW() as fecha";var t=(await c.query(e,{type:c.QueryTypes.SELECT}))[0].fecha;const s=`SELECT t.*, u.*, \n                      CASE WHEN t.carrera_id IS NULL THEN 'VISITANTE' \n                          ELSE c.nombre \n                          END AS carrera,\n                      TIME(h.fecha) AS hora_ingreso\n                  FROM tarjetas t\n                  JOIN usuarios u ON t.cedula = u.cedula\n                  LEFT JOIN historiales h ON h.tarjeta_id = t.iCardCode\n                  LEFT JOIN carreras c ON t.carrera_id = c.id\n                  WHERE h.estatus = 1\n                    AND CAST(h.fecha AS DATE) = '${u(t).tz("America/Caracas").format("YYYY-MM-DD")}'\n                  GROUP BY t.cedula\n                  HAVING SUM(h.tipo = 1) > SUM(h.tipo = 2)\n                  ORDER BY(hora_ingreso) DESC\n                  `,r=await c.query(s,{type:c.QueryTypes.SELECT}),o=r.filter((e=>1===e.tipo_id)).length,i=o+r.filter((e=>2===e.tipo_id)).length+r.filter((e=>3===e.tipo_id)).length,n={Usuarios:i,Empleados:r.filter((e=>4===e.tipo_id)).length,Visitantes:r.filter((e=>5===e.tipo_id)).length,Personas:r};a.status(200).json(n)}catch(e){console.error(e),a.status(200).json({message:"Ha ocurrido un error"})}},ingresaron_salieron_hoy:async(e,a)=>{const{tipo_acceso:t}=e.params,c=new Date;c.setHours(0,0,0,0);const d=await s.findAll({attributes:["id","fecha","estatus"],include:[{model:i,include:[{model:o,attributes:["avatar","nombres","apellidos","cedula"]}]},{model:r,attributes:["id","nombre"]},{model:l,attributes:["id","nombre"]},{model:p,attributes:["id","nombre"]}],where:{tipo:t,fecha:{[n.gt]:c}},order:[["fecha","DESC"]]});a.json(d)},estadisticas_ingreso_hora:async(e,a)=>{try{const e=[],t=[];for(let a=8;a<=17;a++){const r=new Date;r.setHours(a,0,0,0);const o=new Date;o.setHours(a+1,0,0,0);const i=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[r,o]}}});e.push(`${a}-${a+1}`),t.push(i)}const r={hora:e,ingresosCounts:t};a.json(r)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}}}},621:(e,a,t)=>{const s=t(498),{Op:r}=(t(618),t(732),t(496));function o(e,a){const t=new Date(Number(e));return t.setDate(e.getDate()+a),t}function i(e){return`${new Date(e).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}).replace("/","-").replace("/","-")}`}t(238),t(245),e.exports={ingresos_usuarios_agregar:async(e,a)=>{try{const t=[],n=[],c=e.body.intervalo,d=e.body.tiempo,u=e.body.tipo_id;let l=0;1==d&&(l=1),2==d&&(l=7),3==d&&(l=30),4==d&&(l=360);const p=l*c,h=new Date;let m=new Date(h.setDate(h.getDate()-p+1)).toISOString().split("T")[0];for(let e=0,a=1;e<p;e+=l,a++){m=new Date(m);const e=m,a=o(e,l),c=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:{[r.in]:1==u?[1,2,3]:2==u?[1]:3==u?[2]:4==u?[3]:5==u?[4]:[5]}}});m=o(m,l).toISOString().split("T")[0],t.push(`${i(a)}`),n.push(c)}a.json({dias:t,ingresosCounts:n})}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}},ingresos_usuarios_desagregar:async(e,a)=>{try{const t=[],n=[],c=[],d=[],u=[],l=[],p=[],h=[],m=[],w=[],_=[],f=[],y=[],b=e.body.intervalo,g=e.body.tiempo,E=e.body.tipo_id;let D=0;1==g&&(D=1),2==g&&(D=7),3==g&&(D=30),4==g&&(D=360);const T=D*b,N=new Date;let j=new Date(N.setDate(N.getDate()-T+1)).toISOString().split("T")[0];for(let e=0,a=1;e<T;e+=D,a++){j=new Date(j);const e=j,a=o(e,D);if(1==E){const t=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:1}}),o=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2}}),i=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:3}});c.push(t),d.push(o),u.push(i)}else{const t=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:1}}),o=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:2}}),i=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:3}}),n=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:4}}),c=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:5}}),d=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:6}}),u=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:7}}),b=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,a]},tipo_id:2==E?1:2,carrera_id:8}});l.push(t),p.push(o),h.push(i),m.push(n),w.push(c),_.push(d),f.push(u),y.push(b)}j=o(j,D).toISOString().split("T")[0],t.push(`${i(a)}`)}1==E?n.push({name:"Estudiantes",data:c},{name:"Profesores",data:d},{name:"Administrativos",data:u}):n.push({name:"Ingenieria en Informatica",data:l},{name:"Ingenieria Industrial",data:p},{name:"Ingenieria Civil",data:h},{name:"Derecho",data:m},{name:"Comunicacion Social",data:w},{name:"Administracion de Empresas",data:_},{name:"Contaduria Publica",data:f},{name:"Relaciones Industriales",data:y}),a.json({dias:t,ingresosCounts:n})}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}}}},688:(e,a,t)=>{const s=t(498),r=t(618),o=t(295),i=t(732),{Op:n}=t(496),c=t(238);e.exports={obtener_estadisticas_entrada:async(e,a)=>{try{const t=e.body.fecha_inicio,i=e.body.fecha_fin,d=e.body.tipo_acceso,u=await r.count(),l=await s.count({where:{fecha:{[n.between]:[t,i]},tipo:"0"!==d?d:{[n.ne]:0}}}),p=(await c.count({where:{tipo_id:1,cedula:{[n.ne]:0}},group:["cedula"]})).length,h=await s.count({where:{fecha:{[n.between]:[t,i]},tipo_id:1,tipo:"0"!==d?d:{[n.ne]:0}},include:[{model:c,required:!0,include:[{model:r,required:!0},{model:o,required:!0}]}]}),m=await s.count({where:{estatus:"1",tipo:1,tipo:"0"!==d?d:{[n.ne]:0}}}),w=await s.count({where:{fecha:{[n.between]:[t,i]},estatus:"1",tipo:"0"!==d?d:{[n.ne]:0}}}),_={totalUsuarios:u,totalUsuariosRegistradosHoy:l,totalUsuariosTipo1:p,totalUsuariosTipo1RegistradosHoy:h,totalPasesValidos:m,totalPasesValidosHoy:w,totalPasesInvalidos:await s.count({where:{estatus:{[n.not]:"1"},tipo:"0"!==d?d:{[n.ne]:0}}}),totalPasesInvalidosHoy:await s.count({where:{fecha:{[n.between]:[t,i]},estatus:{[n.not]:"1"},tipo:"0"!==d?d:{[n.ne]:0}}})};a.status(200).json(_)}catch(e){console.error(e),a.status(200).json({message:"Error al obtener las estadisticas"})}},ingresos_grafico:async(e,a)=>{try{const t=[],r=[],o=new Date(e.body.fechaInicio),i=new Date(e.body.fechaFin),c=Math.abs(i-o),d=Math.ceil(c/864e5);for(let e=0;e<d;e++){const a=new Date(o);a.setDate(a.getDate()+e);const c=new Date(a);c.setDate(c.getDate()+1);const u=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===d-1?i:c]}}}),l=a.getDate(),p=a.getMonth()+1;t.push(`${l}-${p}`),r.push(u)}const u={dias:t,ingresosCounts:r};a.json(u)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}},ingresos_por_tipo_general:async(e,a)=>{try{const t=[],i=[],d=new Date(e.body.fechaInicio),u=new Date(e.body.fechaFin),l=await o.findAll();for(let e of l){const a=await s.count({include:[{model:c,include:[{model:r}]}],where:{tipo:"1",estatus:"1",fecha:{[n.between]:[d,u]},tipo_id:e.id}});t.push(e.nombre),i.push(a)}const p={tipos:t,ingresosCounts:i};a.json(p)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}},ingresos_por_tipo_detallado:async(e,a)=>{try{const t=[],o=[],i=[],d=[],u=[],l=[],p=new Date(e.body.fechaInicio),h=new Date(e.body.fechaFin),m=Math.abs(h-p),w=Math.ceil(m/864e5);for(let e=0;e<w;e++){const a=new Date(p);a.setDate(a.getDate()+e);const m=new Date(a);m.setDate(m.getDate()+1);const _=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===w-1?h:m]},tipo_id:1},include:{model:c,required:!0,include:{model:r,required:!0}}}),f=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===w-1?h:m]},tipo_id:2},include:{model:c,required:!0,include:{model:r,required:!0}}}),y=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===w-1?h:m]},tipo_id:3},include:{model:c,required:!0,include:{model:r,required:!0}}}),b=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===w-1?h:m]},tipo_id:4},include:{model:c,required:!0,include:{model:r,required:!0}}}),g=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===w-1?h:m]},tipo_id:5},include:{model:c,required:!0,include:{model:r,required:!0}}}),E=a.getDate(),D=a.getMonth()+1;t.push(`${E}-${D}`),o.push(_),i.push(f),d.push(y),u.push(b),l.push(g)}const _={dias:t,ingresosEstudiantes:o,ingresosProfesores:i,ingresosAdministrativos:d,ingresosEmpleados:u,ingresosVisitantes:l};a.json(_)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}},ingresos_por_carrera_general:async(e,a)=>{try{const t=[],o=[],d=new Date(e.body.fechaInicio),u=new Date(e.body.fechaFin),l=await i.findAll();for(let e of l){const a=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[d,u]},carrera_id:e.id},include:[{model:c,include:[{model:r,as:"Usuario"},{model:i,as:"Carrera"}]}]});t.push(e.nombre),o.push(a)}const p={carreras:t,ingresosCounts:o};a.json(p)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}},ingresos_por_carrera_detallado:async(e,a)=>{try{const t=[],r=[],o=[],i=[],c=[],d=[],u=[],l=[],p=[],h=new Date(e.body.fechaInicio),m=new Date(e.body.fechaFin),w=Math.abs(m-h),_=Math.ceil(w/864e5);for(let e=0;e<_;e++){const a=new Date(h);a.setDate(a.getDate()+e);const w=new Date(a);w.setDate(w.getDate()+1);const f=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:1}}),y=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:2}}),b=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:3}}),g=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:4}}),E=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:5}}),D=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:6}}),T=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:7}}),N=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===_-1?m:w]},carrera_id:8}}),j=a.getDate(),C=a.getMonth()+1;t.push(`${j}-${C}`),r.push(f),o.push(y),i.push(b),c.push(g),d.push(E),u.push(D),l.push(T),p.push(N)}const f={dias:t,ingresosInformatica:r,ingresosIndustrial:o,ingresosCivil:i,ingresosDerecho:c,ingresosComunicacion:d,ingresosAdministracionEmpresas:u,ingresosContaduriaPublica:l,ingresosRelacionesIndustriales:p};a.json(f)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}},ingresos_personalizado:async(e,a)=>{const{tipo_id:t,carrera_id:r}=e.body;try{const o=[],i=[],c=new Date(e.body.fechaInicio),d=new Date(e.body.fechaFin),u=Math.abs(d-c),l=Math.ceil(u/864e5),p=0==r?{}:{carrera_id:r},h=0==t?{}:{tipo_id:t};for(let e=0;e<l;e++){const a=new Date(c);a.setDate(a.getDate()+e);const t=new Date(a);t.setDate(t.getDate()+1);const r=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[a,e===l-1?d:t]},...p,...h}}),u=a.getDate(),m=a.getMonth()+1;o.push(`${u}-${m}`),i.push(r)}const m={dias:o,ingresos:i};a.json(m)}catch(e){console.error(e),a.status(500).json({error:"Internal server error"})}}}},670:(e,a,t)=>{const s=t(321),r=t(245);e.exports={que_hora_es:async(e,a)=>{var t=(await s.query("select NOW() as fecha",{type:s.QueryTypes.SELECT}))[0].fecha,o=r(t).tz("America/Caracas").format("YYYY-MM-DD"),i=new Date;return a.json({hora_bdd:o,hora_servidor:i.getHours()+":"+i.getMinutes()})}}},873:(e,a,t)=>{const s=t(732),r=t(295),o=t(618),i=(t(275),t(238)),{Op:n,Sequelize:c}=t(496),d=t(498),u=t(321);e.exports={usuarios:async(e,a)=>{const t=await o.findAll({include:[{model:i,where:{tipo_id:{[n.ne]:5}},required:!0,include:[{model:r},{model:s}],attributes:{include:[[c.literal("(SELECT COUNT(historiales.id) FROM historiales WHERE historiales.tarjeta_id = Tarjeta.iCardCode AND historiales.tipo = 1 AND historiales.estatus = 1)"),"totalIngresos"]]}}]});a.json(t)},visitantes:async(e,a)=>{const t=await i.findAll({where:{estatus:1,tipo_id:5},include:[{model:o,required:!0}]});a.json(t)},todos_usuarios:async(e,a)=>{const t=(await i.findAll({where:{estatus:1,cedula:{[n.ne]:0}},include:[{model:o,required:!0},{model:r,required:!0},{model:s,required:!1}]})).filter((e=>0!==e.cedula)).map((e=>({value:e.cedula,tipo:e.Tipo.id,label:`${e.Tipo.nombre.substring(0,3)} - ${e.Usuario.cedula} : ${e.Usuario.nombres} ${e.Usuario.apellidos}`})));a.json(t)},historial_usuario_particular:async(e,a)=>{const{cedula:t,fechaInicio:c,fechaFin:u}=e.body,l=await o.findOne({where:{cedula:t},include:[{model:i,include:[{model:r},{model:s}]}]}),p=await i.findAll({where:{cedula:l.cedula}});let h=[];for(let e of p){const a=await d.findAll({where:{tarjeta_id:e.iCardCode,fecha:{[n.between]:[c,u]}},include:[{model:r,attributes:["nombre"]},{model:s,attributes:["nombre"]}],order:[["fecha","desc"]]});h.push(...a)}h.sort(((e,a)=>a.fecha-e.fecha)),a.json({historial:h,usuario:l})},visitante_crear:async(e,a)=>{const{cedula:t,nombres:s,apellidos:r,detalles:n,correo:c,telefono:d}=e.body,u=await o.findByPk(t);if(console.log("hola mundo"),u)return a.json({error:"La cedula ya se encuentra registrada"});let l=Math.floor(9e4*Math.random())+1e4,p=Math.floor(900*Math.random())+100;const h=await o.create({cedula:t,nombres:s,apellidos:r,estatus:1,detalles:n,correo:c,telefono:d}),m=await i.create({cedula:t,tipo_id:5,estatus:1,iCardCode:l,iSiteCode:p},{fields:["cedula","tipo_id","estatus","iCardCode","iSiteCode"]});return h&&m?a.json({exito:"Visitante creado con exito"}):a.json({error:"Ha ocurrido un error inesperado"})},visitante_actualizar:async(e,a)=>{const{cedula:t,cedula_vieja:s,nombres:r,apellidos:i,detalles:n,correo:c,telefono:d}=e.body,u=await o.findByPk(t);return t!==s&&u?a.json({error:"La cedula ya se encuentra registrada"}):await o.update({cedula:t,nombres:r,apellidos:i,detalles:n,correo:c,telefono:d},{where:{cedula:s}})?a.json({exito:"Visitante creado con exito"}):a.json({error:"Ha ocurrido un error inesperado"})},cambiar_estado:async(e,a)=>{const{cedula:t}=e.params;await o.update({estatus:u.literal("CASE WHEN estatus = 1 THEN 2 ELSE 1 END")},{where:{cedula:t}});const s=await o.findByPk(t);a.json(2===s.estatus)},actualizar_informacion:async(e,a)=>{const{cedula:t,detalles:s,telefono:r}=e.body;await o.update({detalles:s,telefono:r},{where:{cedula:t}}),a.json({exito:"Actualizacion exitosa"})},updateUser:async(e,a)=>{const{user_id:t,password:s,name:r,last_name:o,type:i}=e.body,n=await User.findOne({where:{user_id:t}});n.password=s,n.name=r,n.last_name=o,n.type=i,await User.save(),a.json({mensaje:"User actualizado correctamente"})},insertPhoto:async(e,a)=>{const{user_id:t,photo:s}=e.body;(await User.findOne({where:{user_id:t}})).photo=s,await User.save(),a.json({mensaje:"Foto cargada!"})}}},138:(e,a,t)=>{const s=t(860),r=t(582),o=t(685),i=t(77),n=t(142),c=t(17);n.config({path:c.resolve(__dirname,".env")});const d=t(866),u=t(456),l=t(279),p=t(388),h=t(454),m=t(14),w=t(331);let _=s(),f=o.createServer(_);const y=t(952)(f,{cors:{origin:"*",methods:["GET","POST"]}});_.io=y,y.on("connection",(()=>{console.log("Conexion al socket exitosa")})),_.use(r()),_.use(s.urlencoded({extended:!1})),_.use(s.json()),_.use(d),_.use(u),_.use(l),_.use(p),_.use(h),_.use(m),_.use(w);const b=process.env.PORT||3e3;f.listen(b,"0.0.0.0",(()=>{console.log(`Servidor corriendo en el puerto ${b}`)})),_.get("/",((e,a)=>{const t=i.address();a.send(t)})),e.exports=_},672:(e,a,t)=>{const s=t(860),r=t(344),o=s.Router();o.use(((e,a,t)=>{let s=e.headers["x-access-token"]||e.headers.authorization;if(!s||null==s)return a.status(401).json({error:"Es necesario el token para acceder a la aplicación"});s.startsWith("Bearer ")&&(s=s.slice(7,s.length)),s&&r.verify(s,"KGGK>HKHVHJVKBKJKJBKBKHKBMKHB",((s,r)=>{if(s)return a.json({message:"Token no válido"});e.decoded=r,t()}))})),e.exports=o},275:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321).define("Abscripcion",{id:{type:s.INTEGER,primaryKey:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"abscripciones"});e.exports=r},813:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321),o=t(39),i=t(602),n=r.define("Administrador",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},nombre_completo:{type:s.STRING,allowNull:!1},nick:{type:s.STRING,allowNull:!1},clave:{type:s.STRING,allowNull:!1},estatus:{type:s.ENUM("1","0"),defaultValue:"1"},principal:{type:s.ENUM("1","0"),defaultValue:"2"}},{timestamps:!1,tableName:"administradores"});n.belongsToMany(o,{through:i,foreignKey:"administrador_id",otherKey:"permiso_id",as:"permisos"}),e.exports=n},732:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321).define("Carrera",{id:{type:s.INTEGER,primaryKey:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"carreras"});e.exports=r},498:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321),o=t(275),i=t(732),n=t(238),c=t(295),d=r.define("Historial",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},fecha:{type:s.DATE,allowNull:!1},estatus:{type:s.ENUM("1","2","3"),defaultValue:"1"},tipo:{type:s.ENUM("1","2"),defaultValue:"1"},tarjeta_id:{type:s.INTEGER,allowNull:!0,references:{model:n,key:"iCardCode"}},tipo_id:{type:s.INTEGER,allowNull:!0,references:{model:c,key:"id"}},carrera_id:{type:s.INTEGER,allowNull:!0,references:{model:i,key:"id"}},abscripcion_id:{type:s.INTEGER,allowNull:!0,references:{model:o,key:"id"}}},{timestamps:!1,tableName:"historiales"});d.belongsTo(n,{foreignKey:"tarjeta_id"}),d.belongsTo(c,{foreignKey:"tipo_id"}),d.belongsTo(i,{foreignKey:"carrera_id"}),d.belongsTo(o,{foreignKey:"abscripcion_id"}),e.exports=d},39:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321).define("Permiso",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"permisos"});e.exports=r},602:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321),o=t(39),i=t(813),n=r.define("PermisoAdministrador",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},permiso_id:{type:s.INTEGER,allowNull:!0,references:{model:o,key:"id"}},administrador_id:{type:s.INTEGER,allowNull:!0,references:{model:i,key:"id"}}},{timestamps:!1,tableName:"permiso_administrador"});e.exports=n},238:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321),o=t(275),i=t(732),n=t(295),c=t(618),d=r.define("Tarjeta",{iCardCode:{type:s.INTEGER,primaryKey:!0},iSiteCode:{type:s.INTEGER,primaryKey:!0},estatus:{type:s.ENUM("1","0"),defaultValue:"1"},cedula:{type:s.INTEGER,allowNull:!1,references:{model:c,key:"cedula"}},tipo_id:{type:s.INTEGER,allowNull:!1,references:{model:n,key:"id"}},carrera_id:{type:s.INTEGER,allowNull:!1,references:{model:i,key:"id"}},abscripcion_id:{type:s.INTEGER,allowNull:!1,references:{model:o,key:"id"}}},{timestamps:!1,tableName:"tarjetas"});d.belongsTo(i,{foreignKey:"carrera_id"}),d.belongsTo(n,{foreignKey:"tipo_id"}),d.belongsTo(o,{foreignKey:"abscripcion_id"}),e.exports=d},295:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321).define("Tipo",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"tipos"});e.exports=r},618:(e,a,t)=>{const{DataTypes:s}=t(496),r=t(321),o=t(238),i=r.define("Usuario",{cedula:{type:s.INTEGER,primaryKey:!0},nombres:{type:s.STRING,allowNull:!1},apellidos:{type:s.STRING,allowNull:!1},detalles:{type:s.TEXT,allowNull:!0},correo:{type:s.STRING,allowNull:!0},telefono:{type:s.NUMBER,allowNull:!0},avatar:{type:s.BLOB},estatus:{type:s.ENUM("1","0"),defaultValue:"1"}},{timestamps:!1,tableName:"usuarios"});i.hasMany(o,{foreignKey:"cedula"}),o.belongsTo(i,{foreignKey:"cedula"}),e.exports=i},14:(e,a,t)=>{const s=t(860),r=t(672),{permisos:o,permisos_administrador:i,crear_administrador:n,todos_administradores:c,cambiar_estado:d,crear:u,mis_permisos:l}=t(340),p=s.Router();p.get("/permisos",o),p.get("/permisos_administrador",i),p.post("/crear_administrador",n),p.get("/administradores/todos_administradores",c),p.get("/administradores/cambiar_estado/:administrador_id",r,d),p.get("/administradores/mis_permisos",r,l),p.post("/administradores/:tipo",r,u),e.exports=p},866:(e,a,t)=>{const s=t(860),{login:r}=t(93),o=s.Router();o.post("/login",r),e.exports=o},279:(e,a,t)=>{const s=t(860),r=t(672),{validar_tarjeta_entrada:o,validar_tarjeta_salida:i,historial:n,entrar_salir:c,personas_edificio:d,ingresaron_salieron_hoy:u,estadisticas_ingreso_hora:l}=t(631),p=s.Router();p.get("/control-acceso/validar-entrada/:iCardCode",o),p.get("/control-acceso/validar-salida/:iCardCode",i),p.get("/control-acceso/:tipo_acceso/:cedula/:tipo_id",r,c),p.get("/control-acceso/estadisticas_ingreso_hora",r,l),p.get("/personas_edificio",r,d),p.get("/ingresaron_salieron_hoy/:tipo_acceso",r,u),p.post("/historial",r,n),e.exports=p},454:(e,a,t)=>{const s=t(860),r=t(672),{ingresos_usuarios_agregar:o,ingresos_usuarios_desagregar:i}=t(621),n=s.Router();n.post("/estadisticas/usuarios/agregar",r,o),n.post("/estadisticas/usuarios/desagregar",r,i),e.exports=n},388:(e,a,t)=>{const s=t(860),r=t(672),{obtener_estadisticas_entrada:o,ingresos_grafico:i,ingresos_por_tipo_general:n,ingresos_por_tipo_detallado:c,ingresos_por_carrera_general:d,ingresos_por_carrera_detallado:u,ingresos_personalizado:l}=t(688),p=s.Router();p.post("/panel/obtener_estadisticas_entrada",r,o),p.post("/panel/ingresos_grafico",r,i),p.post("/panel/ingresos_por_tipo_general",r,n),p.post("/panel/ingresos_por_tipo_detallado",r,c),p.post("/panel/ingresos_por_carrera_general",r,d),p.post("/panel/ingresos_por_carrera_detallado",r,u),p.post("/panel/ingresos_personalizado",r,l),e.exports=p},331:(e,a,t)=>{const s=t(860),{que_hora_es:r}=t(670),o=s.Router();o.get("/que_hora_es",r),e.exports=o},456:(e,a,t)=>{const s=t(860),{todos_usuarios:r,usuarios:o,visitantes:i,visitante_crear:n,visitante_actualizar:c,historial_usuario_particular:d,cambiar_estado:u,actualizar_informacion:l}=t(873),p=t(672),h=s.Router();h.get("/todos_usuarios",p,r),h.get("/usuarios",p,o),h.post("/usuarios/historial_usuario_particular",p,d),h.get("/usuarios/cambiar_estado/:cedula",p,u),h.post("/usuarios/actualizar/informacion",p,l),h.get("/visitantes",p,i),h.post("/visitantes/crear",p,n),h.post("/visitantes/actualizar",p,c),e.exports=h},167:e=>{"use strict";e.exports=require("axios")},96:e=>{"use strict";e.exports=require("bcrypt")},582:e=>{"use strict";e.exports=require("cors")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},77:e=>{"use strict";e.exports=require("ip")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},245:e=>{"use strict";e.exports=require("moment")},496:e=>{"use strict";e.exports=require("sequelize")},952:e=>{"use strict";e.exports=require("socket.io")},685:e=>{"use strict";e.exports=require("http")},17:e=>{"use strict";e.exports=require("path")}},a={};!function t(s){var r=a[s];if(void 0!==r)return r.exports;var o=a[s]={exports:{}};return e[s](o,o.exports,t),o.exports}(138)})();